#!/bin/python
import os;

import socket;
import fcntl;
import struct;

'''
This script consumes the /etc/sysconfig/riak file and updates the state
of the riak ring according to this file. The /etc/sysconfig/riak file
contains the target state of the ring.

Need to knows: 

* When a node is added to the cluster, any node already belonging to the 
cluster is allowed to add the new node to the cluster by executing the
join command. The join command is idempotent while not exploited by
this script
* When a node is removed from the cluster, the node must remove itself
from the cluster by executing the remove command.
'''

# update the ring configuration according to the config file
def updateNodesInRing(pathToConfigFile):
	os.popen("ulimit -n 65536");
	os.popen("chsh -s /bin/bash riak");
	configIps = getIpsConfigFile(pathToConfigFile);
	currentIps = getIpsInRing();
	if (getOwnIp() not in configIps):
		removeSelfFromRing();
	else:
		ipsNotYetInRing = getDifference(configIps,currentIps);
		addIpsToRing(ipsNotYetInRing);
	commitConfiguration();

# Returns all the elements in the first list not contained in the second list
def getDifference(list1, list2):
	result = [];
	for elem in list1:
		if (elem not in list2):
			result.append(elem);
	return result;

# Returns the ip-addresses of the nodes in the ring
def getIpsConfigFile(pathToConfigFile):
	filestream = open(pathToConfigFile,"r");
	ips = [];
	for line in filestream:
		if line.find("update_riak_nodes") != -1:
			ip = line.split(' ')[1];
			ip = ip.strip(" \n");
			ips.append(ip);
	filestream.close();
	return ips;

# Returns the ip-addresses of the nodes currently in the ring
# Ouput of command looks like: "ring_members : ['riak@192.168.1.10','riak@192.168.1.11']"
def getIpsInRing():
	output = os.popen('/bin/riak-admin status | grep ring_members').read();
	index = output.index('[');
	output = output[index:];
	output = output.strip(" \n[]");
	hostAndIpAddress = output.split(',');
	result = [];
	for entry in hostAndIpAddress:
		entry = entry.strip("'");
		ip = entry.split('@')[1];
		result.append(ip);
	return result;

# Remove this node from the ring (the node this script runs on)
def removeSelfFromRing():
	ownIp = getOwnIp();
	command = "/bin/riak-admin cluster leave riak@" + ownIp;
	os.popen(command);

# Add ip addresses of nodes to the ring
def addIpsToRing(ips):
	for ip in ips:
		command = "/bin/riak-admin cluster join riak@" + ip;
		os.popen(command);

# Commit changes made to the configuration file
def commitConfiguration():
	os.popen('/bin/riak-admin cluster plan');
	os.popen('/bin/riak-admin cluster commit');

# Get the ip address of the interface "p2p1" from the node
# this script is running on.
def getOwnIp():
	s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM);
	result = socket.inet_ntoa(fcntl.ioctl(
        s.fileno(),
        0x8915,  # SIOCGIFADDR
        struct.pack('256s', "eth0"[:15])
	)[20:24]);
	return result.strip("\n ");

# Start of script
updateNodesInRing("/etc/sysconfig/riak");
